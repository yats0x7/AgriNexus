import React, { useState, useEffect } from 'react';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Badge } from '@/components/ui/badge';
import { Alert, AlertDescription } from '@/components/ui/alert';
import { DataSource } from '@/entities/DataSource';
import { 
    Database, 
    CheckCircle, 
    AlertCircle, 
    XCircle, 
    RefreshCw, 
    Activity,
    Calendar,
    TrendingUp
} from 'lucide-react';
import { format } from 'date-fns';

export default function DataSourceMonitor() {
    const [dataSources, setDataSources] = useState([]);
    const [isLoading, setIsLoading] = useState(false);

    const fetchDataSources = async () => {
        setIsLoading(true);
        try {
            const sources = await DataSource.list();
            setDataSources(sources);
        } catch (error) {
            console.error("Error fetching data sources:", error);
        }
        setIsLoading(false);
    };

    useEffect(() => {
        fetchDataSources();
        // Refresh every 30 seconds for real-time monitoring
        const interval = setInterval(fetchDataSources, 30000);
        return () => clearInterval(interval);
    }, []);

    const getStatusIcon = (status) => {
        switch (status) {
            case 'active':
                return <CheckCircle className="w-5 h-5 text-green-600" />;
            case 'error':
                return <XCircle className="w-5 h-5 text-red-600" />;
            case 'disabled':
                return <AlertCircle className="w-5 h-5 text-gray-600" />;
            default:
                return <AlertCircle className="w-5 h-5 text-gray-600" />;
        }
    };

    const getStatusBadge = (status) => {
        const configs = {
            active: { color: "bg-green-100 text-green-800", label: "Active" },
            error: { color: "bg-red-100 text-red-800", label: "Error" },
            disabled: { color: "bg-gray-100 text-gray-800", label: "Disabled" }
        };
        return configs[status] || configs.disabled;
    };

    const activeCount = dataSources.filter(s => s.status === 'active').length;
    const errorCount = dataSources.filter(s => s.status === 'error').length;

    return (
        <div className="space-y-6">
            {/* Summary Cards */}
            <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                <Card>
                    <CardContent className="p-6 text-center">
                        <Database className="w-8 h-8 text-blue-600 mx-auto mb-2" />
                        <p className="text-2xl font-bold">{dataSources.length}</p>
                        <p className="text-sm text-gray-600">Total Sources</p>
                    </CardContent>
                </Card>
                <Card>
                    <CardContent className="p-6 text-center">
                        <CheckCircle className="w-8 h-8 text-green-600 mx-auto mb-2" />
                        <p className="text-2xl font-bold text-green-600">{activeCount}</p>
                        <p className="text-sm text-gray-600">Active</p>
                    </CardContent>
                </Card>
                <Card>
                    <CardContent className="p-6 text-center">
                        <XCircle className="w-8 h-8 text-red-600 mx-auto mb-2" />
                        <p className="text-2xl font-bold text-red-600">{errorCount}</p>
                        <p className="text-sm text-gray-600">Errors</p>
                    </CardContent>
                </Card>
                <Card>
                    <CardContent className="p-6 text-center">
                        <Activity className="w-8 h-8 text-purple-600 mx-auto mb-2" />
                        <p className="text-2xl font-bold">{Math.round(activeCount / dataSources.length * 100)}%</p>
                        <p className="text-sm text-gray-600">Uptime</p>
                    </CardContent>
                </Card>
            </div>

            {/* Data Sources List */}
            <Card className="shadow-lg">
                <CardHeader>
                    <div className="flex justify-between items-center">
                        <CardTitle className="flex items-center gap-2">
                            <Database className="w-5 h-5" />
                            Government Data Sources
                        </CardTitle>
                        <Button onClick={fetchDataSources} disabled={isLoading}>
                            <RefreshCw className={`w-4 h-4 mr-2 ${isLoading ? 'animate-spin' : ''}`} />
                            Refresh
                        </Button>
                    </div>
                </CardHeader>
                <CardContent>
                    <div className="space-y-4">
                        {dataSources.map((source) => (
                            <Card key={source.id} className="border">
                                <CardContent className="p-4">
                                    <div className="flex flex-col md:flex-row justify-between items-start gap-4">
                                        <div className="flex-1">
                                            <div className="flex items-center gap-3 mb-2">
                                                {getStatusIcon(source.status)}
                                                <h3 className="font-semibold text-lg">{source.source_name}</h3>
                                                <Badge className={getStatusBadge(source.status).color}>
                                                    {getStatusBadge(source.status).label}
                                                </Badge>
                                            </div>
                                            
                                            <div className="space-y-1 text-sm text-gray-600">
                                                <p><strong>Endpoint:</strong> {source.endpoint_url}</p>
                                                <p><strong>Type:</strong> {source.source_type}</p>
                                                <p><strong>Frequency:</strong> {source.fetch_frequency}</p>
                                                {source.last_fetch && (
                                                    <p className="flex items-center gap-1">
                                                        <Calendar className="w-4 h-4" />
                                                        Last fetch: {format(new Date(source.last_fetch), 'MMM dd, HH:mm')}
                                                    </p>
                                                )}
                                            </div>
                                        </div>
                                        
                                        <div className="text-right space-y-2">
                                            <div className="flex items-center gap-2">
                                                <TrendingUp className="w-4 h-4 text-blue-600" />
                                                <span className="font-bold text-blue-600">
                                                    {source.records_fetched?.toLocaleString() || 0} records
                                                </span>
                                            </div>
                                            {source.error_count > 0 && (
                                                <Alert className="bg-red-50 border-red-200 p-2">
                                                    <AlertDescription className="text-xs text-red-800">
                                                        {source.error_count} consecutive errors
                                                    </AlertDescription>
                                                </Alert>
                                            )}
                                        </div>
                                    </div>
                                </CardContent>
                            </Card>
                        ))}
                    </div>
                </CardContent>
            </Card>
        </div>
    );
}