
import React, { useState, useEffect, useCallback } from 'react';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Textarea } from '@/components/ui/textarea';
import { Label } from '@/components/ui/label';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';
import { MapPin, Phone, UserCheck, Loader2, Navigation } from 'lucide-react';
import { Expert } from '@/entities/Expert';
import LocationSelector from '../components/shared/LocationSelector';
import { Badge } from '@/components/ui/badge';

export default function FieldVisitPage() {
    const [formData, setFormData] = useState({
        farmer_name: '',
        phone_number: '',
        issue_description: ''
    });
    const [selectedState, setSelectedState] = useState("Punjab");
    const [selectedDistrict, setSelectedDistrict] = useState("Ludhiana");
    const [visitRequested, setVisitRequested] = useState(false);
    const [nearbyExperts, setNearbyExperts] = useState([]);
    const [isLoading, setIsLoading] = useState(false);
    
    const fetchExperts = useCallback(async () => {
        if (!selectedDistrict) return;
        setIsLoading(true);
        try {
            // In a real app, this would filter by location
            const allExperts = await Expert.list();
            const filtered = allExperts.filter(e => e.location?.includes(selectedDistrict)).slice(0, 3);
            setNearbyExperts(filtered.length > 0 ? filtered : allExperts.slice(0,3)); // Fallback for demo
        } catch (error) {
            console.error("Error fetching experts:", error);
        }
        setIsLoading(false);
    }, [selectedDistrict]);

    const handleRequestVisit = (e) => {
        e.preventDefault();
        setVisitRequested(true);
        fetchExperts();
    };

    return (
        <div className="min-h-screen p-6 bg-gradient-to-br from-teal-50 via-white to-cyan-50">
            <div className="max-w-4xl mx-auto space-y-8">
                <div className="text-center space-y-4">
                     <div className="w-16 h-16 bg-gradient-to-r from-teal-500 to-cyan-600 rounded-2xl flex items-center justify-center shadow-lg mx-auto">
                        <UserCheck className="w-8 h-8 text-white" />
                    </div>
                    <h1 className="text-4xl font-bold text-gray-900">Request a Field Visit</h1>
                    <p className="text-xl text-gray-600 max-w-2xl mx-auto">
                        Schedule a visit from a local agricultural officer or KVK expert.
                    </p>
                </div>
                
                {!visitRequested ? (
                    <Card className="shadow-xl">
                        <CardHeader>
                            <CardTitle>Fill Your Details</CardTitle>
                        </CardHeader>
                        <CardContent>
                            <form onSubmit={handleRequestVisit} className="space-y-6">
                                <div className="space-y-2">
                                    <Label htmlFor="farmer_name">Your Name</Label>
                                    <Input id="farmer_name" value={formData.farmer_name} onChange={e => setFormData({...formData, farmer_name: e.target.value})} required />
                                </div>
                                <div className="space-y-2">
                                    <Label htmlFor="phone_number">Contact Number</Label>
                                    <Input id="phone_number" type="tel" value={formData.phone_number} onChange={e => setFormData({...formData, phone_number: e.target.value})} required />
                                </div>
                                
                                <LocationSelector 
                                    selectedState={selectedState} 
                                    setSelectedState={setSelectedState}
                                    selectedDistrict={selectedDistrict}
                                    setSelectedDistrict={setSelectedDistrict}
                                />
                                
                                <div className="space-y-2">
                                    <Label htmlFor="issue_description">Describe the Issue</Label>
                                    <Textarea id="issue_description" value={formData.issue_description} onChange={e => setFormData({...formData, issue_description: e.target.value})} required className="h-32" />
                                </div>
                                
                                <Button type="submit" className="w-full bg-teal-600 hover:bg-teal-700 text-lg py-6">
                                    Find Nearby Experts
                                </Button>
                            </form>
                        </CardContent>
                    </Card>
                ) : (
                    <Card className="shadow-xl">
                        <CardHeader>
                            <CardTitle className="flex items-center justify-between">
                                <span>Experts Near {selectedDistrict}</span>
                                <Button variant="outline" onClick={() => setVisitRequested(false)}>New Request</Button>
                            </CardTitle>
                            <p className="text-gray-600">Contact one of the experts below to schedule your visit.</p>
                        </CardHeader>
                        <CardContent>
                            {isLoading ? (
                                <div className="text-center py-12"><Loader2 className="w-8 h-8 animate-spin mx-auto text-teal-600" /></div>
                            ) : nearbyExperts.length > 0 ? (
                                <div className="space-y-4">
                                    {nearbyExperts.map(expert => (
                                        <Card key={expert.id} className="p-4">
                                            <div className="flex flex-col md:flex-row gap-4">
                                                <img src={expert.profile_image || `https://ui-avatars.com/api/?name=${expert.name.replace(' ', '+')}&background=0D9488&color=fff`} alt={expert.name} className="w-24 h-24 rounded-full mx-auto md:mx-0" />
                                                <div className="flex-1 text-center md:text-left">
                                                    <h3 className="text-lg font-bold">{expert.name}</h3>
                                                    <p className="text-sm text-gray-600">{expert.qualification}</p>
                                                    <div className="flex flex-wrap gap-1 mt-2 justify-center md:justify-start">
                                                        {expert.specialization.map(spec => <Badge key={spec}>{spec}</Badge>)}
                                                    </div>
                                                </div>
                                                <div className="flex flex-col items-center justify-center gap-2">
                                                    <Button className="w-full md:w-auto bg-teal-600 hover:bg-teal-700">
                                                        <Phone className="w-4 h-4 mr-2" />
                                                        {expert.contact_number}
                                                    </Button>
                                                    <Button variant="outline" className="w-full md:w-auto">
                                                        <Navigation className="w-4 h-4 mr-2" />
                                                        Get Directions
                                                    </Button>
                                                </div>
                                            </div>
                                        </Card>
                                    ))}
                                </div>
                            ) : (
                                <p className="text-center py-12 text-gray-500">No experts found for your selected location. Please try a different district.</p>
                            )}
                        </CardContent>
                    </Card>
                )}
            </div>
        </div>
    );
}
